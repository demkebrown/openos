
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>37. Read-Dominated Workloads &#8212; Introduction to Operating Systems</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="38. Challenges of Modern Hardware" href="hardware_challenges.html" />
    <link rel="prev" title="36. Common Concurrency Bugs" href="concurrency_bugs.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Introduction to Operating Systems</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro/pref.html">
                    Preface
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/intro.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/purpose.html">
   2. Purpose of operating systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/structure.html">
   3. Operating System Structure &amp; Unix/Linux
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/abstractions.html">
   4. Operating System Abstractions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/tools.html">
   5. Tools
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Virtual Processor
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/intro.html">
   6. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/process.html">
   7. Virtualizing a CPU
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/scheduling.html">
   8. Scheduling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/real_sched.html">
   9. A Look at the Linux Scheduler
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  File Systems
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/intro.html">
   10. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/interface.html">
   11. File System Abstraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/diskhw.html">
   12. A bit about Disks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/disklayout.html">
   13. File System Layout
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_track_used.html">
   14. Disk Layout:Tracking Used Space
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_track_free.html">
   15. Disk Layout:Tracking Free Space
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_name.html">
   16. Disk Layout:Implementing Name Space
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_failures.html">
   17. Disk Layout:Dealing with Failures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_ex_exx.html">
   18. Disk Layout:Examples of Real World File Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/kernelimp.html">
   19. Kernel implementation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Virtual Memory
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/intro.html">
   20. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/phys-and-seg.html">
   21. Memory management before paged virtual memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/virt-paging.html">
   22. Paging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/page-tables.html">
   23. Page Tables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/reclamation.html">
   24. Memory reclaiming algorithms.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/page-size.html">
   25. Page Sizes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/misc.html">
   26. Other topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/buffer-cache.html">
   27. Buffer Cache
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/pagefaults.html">
   28. Memory Management Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/realworld.html">
   29. Memory management in the real world
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/concl.html">
   30. Conclusion
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Concurrency
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sync.html">
   31. Introduction to Concurrency, Synchronization and Deadlock
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sharing.html">
   32. Cooperating Processes and Inter-process Communication
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="criticalsection.html">
   33. The Critical Section Problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="locks.html">
   34. Implementing Locks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ordering.html">
   35. Ordering Thread Events
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="concurrency_bugs.html">
   36. Common Concurrency Bugs
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   37. Read-Dominated Workloads
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hardware_challenges.html">
   38. Challenges of Modern Hardware
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="linux_locking.html">
   39. Locking in the Linux Kernel
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other Topics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../misc/OtherInro.html">
   40. Overview of other topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../virt/virt.html">
   41. Virtualization and Cloud computing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/other.html">
   42. Other OS structures
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../misc/howto.html">
   43. How to read this book
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributing/Contributing.html">
   44. Contributing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../misc/bib.html">
   45. Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/okrieg/openos/main?urlpath=lab/tree/content/sync/readmostly.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://jupyterhub-redhat-ods-applications.apps.buaws-dev.idu6.p1.openshiftapps.com/hub/user-redirect/git-pull?repo=https%3A//github.com/okrieg/openos&urlpath=lab/tree/openos/content/sync/readmostly.ipynb&branch=main"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on JupyterHub"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="headerbtn__text-container">JupyterHub</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/okrieg/openos"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/okrieg/openos/issues/new?title=Issue%20on%20page%20%2Fsync/readmostly.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/okrieg/openos/edit/main/content/sync/readmostly.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/sync/readmostly.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reader-writer-locks">
   37.1. Reader-Writer Locks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-of-rwlocks">
   37.2. Performance of rwlocks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-copy-update">
   37.3. Read-Copy Update
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Read-Dominated Workloads</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reader-writer-locks">
   37.1. Reader-Writer Locks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-of-rwlocks">
   37.2. Performance of rwlocks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-copy-update">
   37.3. Read-Copy Update
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="cell tag_remove-input docutils container">
</div>
<section class="tex2jax_ignore mathjax_ignore" id="read-dominated-workloads">
<span id="cont-sync-readmostly"></span><h1><span class="section-number">37. </span>Read-Dominated Workloads<a class="headerlink" href="#read-dominated-workloads" title="Permalink to this headline">#</a></h1>
<p>There are many scenarios in operating systems and other concurrent software where certain data structures are frequently read, but rarely updated. For example, the OS caches network routing information, but route updates are infrequent compared to route lookups in the cache. Since read-only accesses cannot conflict with each other, we would like to allow “readers” to execute concurrently with each other (sharing access to the data structure), while “writers” must not be allowed to conflict with either readers or other writers. We will look at two ways to solve this problem: classical reader-writer locks (rw_locks), and read-copy-update (RCU).</p>
<section id="reader-writer-locks">
<span id="cont-sync-readmostly-rw-locks"></span><h2><span class="section-number">37.1. </span>Reader-Writer Locks<a class="headerlink" href="#reader-writer-locks" title="Permalink to this headline">#</a></h2>
<p>Courtois et al. first described the reader-writer problem and two solutions using semaphores for mutual exclusion in 1971 <span id="id1">[<a class="reference internal" href="../misc/bib.html#id16" title="P. J. Courtois, F. Heymans, and D. L. Parnas. Concurrent control with “readers” and “writers”. Commun. ACM, 14(10):667–668, oct 1971. URL: https://doi.org/10.1145/362759.362813, doi:10.1145/362759.362813.">CHP71</a>]</span>. In the first version of the problem, readers have priority over writers: a reader thread should never be prevented from accessing the resource unless a writer has already been granted exclusive use of the resource. We show the solution for this reader-priority version in <a class="reference internal" href="#listing-sync-readmostly-readerpri"><span class="std std-numref">Listing 37.1</span></a> using POSIX semaphores. Note that since the semaphores are used only for mutual exclusion, we could replace them with <code class="docutils literal notranslate"><span class="pre">pthread_mutex_t</span></code> or any of our spinlock implementations without making any other changes. We represent access to some shared database with the <code class="docutils literal notranslate"><span class="pre">read_db()</span></code> and <code class="docutils literal notranslate"><span class="pre">write_db()</span></code> functions.</p>
<div class="literal-block-wrapper docutils container" id="listing-sync-readmostly-readerpri">
<div class="code-block-caption"><span class="caption-number">Listing 37.1 </span><span class="caption-text">Reader/writer solution using semaphores; readers have priority over writers.</span><a class="headerlink" href="#listing-sync-readmostly-readerpri" title="Permalink to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">static</span> <span class="n">void</span> <span class="n">read_db</span><span class="p">();</span>
<span class="linenos"> 2</span><span class="n">static</span> <span class="n">void</span> <span class="n">write_db</span><span class="p">();</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">sem_t</span> <span class="n">counter_mutex</span><span class="p">;</span> <span class="o">/*</span> <span class="n">Initially</span> <span class="mi">1</span> <span class="o">*/</span>
<span class="linenos"> 5</span><span class="n">sem_t</span> <span class="n">mutex</span><span class="p">;</span>    <span class="o">/*</span> <span class="n">Initially</span> <span class="mi">1</span> <span class="o">*/</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="nb">int</span> <span class="n">reader_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="n">static</span> <span class="n">void</span> <span class="n">writer</span><span class="p">()</span>
<span class="linenos">10</span><span class="p">{</span>
<span class="hll"><span class="linenos">11</span>    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class="linenos">12</span>    <span class="n">write_db</span><span class="p">();</span>
<span class="hll"><span class="linenos">13</span>    <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class="linenos">14</span><span class="p">}</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="n">static</span> <span class="n">void</span> <span class="n">reader</span><span class="p">()</span>
<span class="linenos">17</span><span class="p">{</span>
<span class="linenos">18</span>    
<span class="hll"><span class="linenos">19</span>    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter_mutex</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">20</span>    <span class="n">reader_count</span><span class="o">++</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">21</span>    <span class="k">if</span> <span class="p">(</span><span class="n">reader_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll"><span class="linenos">22</span>        <span class="o">/*</span> <span class="n">first</span> <span class="n">reader</span> <span class="n">synchronizes</span> <span class="k">with</span> <span class="n">writers</span> <span class="n">to</span> <span class="n">acquire</span> <span class="n">the</span> <span class="n">resource</span> <span class="o">*/</span>
</span><span class="hll"><span class="linenos">23</span>        <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">24</span>    <span class="p">}</span>
</span><span class="hll"><span class="linenos">25</span>    <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter_mutex</span><span class="p">);</span>
</span><span class="linenos">26</span>    
<span class="linenos">27</span>    <span class="n">read_db</span><span class="p">();</span>
<span class="linenos">28</span>    
<span class="hll"><span class="linenos">29</span>    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter_mutex</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">30</span>    <span class="n">reader_count</span><span class="o">--</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">31</span>    <span class="k">if</span> <span class="p">(</span><span class="n">reader_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll"><span class="linenos">32</span>        <span class="o">/*</span> <span class="n">last</span> <span class="n">reader</span> <span class="n">releases</span> <span class="n">the</span> <span class="n">resource</span> <span class="o">*/</span>
</span><span class="hll"><span class="linenos">33</span>        <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">34</span>    <span class="p">}</span>
</span><span class="hll"><span class="linenos">35</span>    <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter_mutex</span><span class="p">);</span>
</span><span class="linenos">36</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>The writer code (lines 11-13) is very simple. We introduce a <code class="docutils literal notranslate"><span class="pre">mutex</span></code> semaphore (line 4) to protect access to the shared data. The <code class="docutils literal notranslate"><span class="pre">wait</span></code> on <code class="docutils literal notranslate"><span class="pre">mutex</span></code> at line 11 ensures that only one writer can be accessing the data at any time; when the writer is done, it <code class="docutils literal notranslate"><span class="pre">post</span></code>s a notice to <code class="docutils literal notranslate"><span class="pre">mutex</span></code> that the data is now available again (line 13). In previous locking scenarios, the reader code would be symmetrical, with each reader also waiting for the <code class="docutils literal notranslate"><span class="pre">mutex</span></code> and <code class="docutils literal notranslate"><span class="pre">post</span></code>ing when it was done. Because we want to allow multiple readers, the reader code needs to do a little more work, however. First, we want to keep track of the number of readers currently accessing the data, so we introduce a <code class="docutils literal notranslate"><span class="pre">reader_count</span></code> variable (line 7), and since this variable will be updated by every reader thread, we also add a <code class="docutils literal notranslate"><span class="pre">counter_mutex</span></code> semaphore (line 5) to protect sections of code that depend on the <code class="docutils literal notranslate"><span class="pre">reader_count</span></code>. Each reader thread begins by <code class="docutils literal notranslate"><span class="pre">wait</span></code>ing for the <code class="docutils literal notranslate"><span class="pre">counter_mutex</span></code>, then increments <code class="docutils literal notranslate"><span class="pre">reader_count</span></code> to add itself to the count of current readers (lines 19-20). Only the first reader thread needs to synchronize with writer threads (lines 21-24)—once a reader has successfully <code class="docutils literal notranslate"><span class="pre">wait</span></code>ed for the <code class="docutils literal notranslate"><span class="pre">mutex</span></code>, writers will be locked out until all the readers are done. Notice also that the first reader does not <code class="docutils literal notranslate"><span class="pre">post</span></code> to the <code class="docutils literal notranslate"><span class="pre">counter_mutex</span></code> until <em>after</em> it has obtained permission to access the data (line 25). This ensures that other reader threads must line up <code class="docutils literal notranslate"><span class="pre">wait</span></code>ing for the <code class="docutils literal notranslate"><span class="pre">counter_mutex</span></code> as long as a writer is accessing the data. When a reader finishes using the data, it must again <code class="docutils literal notranslate"><span class="pre">wait</span></code> for the <code class="docutils literal notranslate"><span class="pre">counter_mutex</span></code> to subtract itself from the count of current readers (lines 29-30). When the <code class="docutils literal notranslate"><span class="pre">reader_count</span></code> falls to zero, it means that the last reader thread is done using the data, and this last thread must <code class="docutils literal notranslate"><span class="pre">post</span></code> a signal to the <code class="docutils literal notranslate"><span class="pre">mutex</span></code> to indicate that the data is available again (lines 31-34). If any writers are waiting, one will be allowed to proceed.</p>
<p>The reader code illustrates the <em>lightswitch pattern</em> in concurrent programming: the analogy is that the first person into a dark room turns on the light (acquires the resource), and the last one to leave turns it off (releases the resource).</p>
<p>We can encapsulate the <em>entry</em> sections of code (line 11 for writers; lines 19-25 for readers) and the <em>exit</em> sections of code (line 13 for writers; lines 29-35 for readers) into acquire and release functions for reader/writer locks. This code is shown in <a class="reference internal" href="#listing-sync-readmostly-rwlock"><span class="std std-numref">Listing 37.2</span></a>:</p>
<div class="literal-block-wrapper docutils container" id="listing-sync-readmostly-rwlock">
<div class="code-block-caption"><span class="caption-number">Listing 37.2 </span><span class="caption-text">C source code for reader/writer locks using semaphores.</span><a class="headerlink" href="#listing-sync-readmostly-rwlock" title="Permalink to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">#include &lt;semaphore.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">rwlock_s</span> <span class="p">{</span>
<span class="linenos"> 4</span>    <span class="nb">int</span> <span class="n">reader_count</span><span class="p">;</span>
<span class="linenos"> 5</span>    <span class="n">sem_t</span> <span class="n">counter_mutex</span><span class="p">;</span>
<span class="linenos"> 6</span>    <span class="n">sem_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="p">}</span> <span class="n">rwlock_t</span><span class="p">;</span> 
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="n">static</span> <span class="n">inline</span> <span class="n">void</span> <span class="n">rwlock_init</span><span class="p">(</span><span class="n">rwlock_t</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">10</span>    <span class="n">l</span><span class="o">-&gt;</span><span class="n">reader_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">11</span>    <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">counter_mutex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="linenos">12</span>    <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="linenos">13</span><span class="p">}</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="n">static</span> <span class="n">inline</span> <span class="n">void</span> <span class="n">rwlock_acquire_write</span><span class="p">(</span><span class="n">rwlock_t</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="linenos">16</span><span class="p">{</span>
<span class="linenos">17</span>    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="linenos">18</span><span class="p">}</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="n">static</span> <span class="n">inline</span> <span class="n">void</span> <span class="n">rwlock_release_write</span><span class="p">(</span><span class="n">rwlock_t</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="linenos">21</span><span class="p">{</span>
<span class="linenos">22</span>    <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="linenos">23</span><span class="p">}</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="n">static</span> <span class="n">inline</span> <span class="n">void</span> <span class="n">rwlock_acquire_read</span><span class="p">(</span><span class="n">rwlock_t</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="linenos">26</span><span class="p">{</span>
<span class="linenos">27</span>    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">counter_mutex</span><span class="p">);</span>
<span class="linenos">28</span>    <span class="n">l</span><span class="o">-&gt;</span><span class="n">reader_count</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">29</span>    <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">reader_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">30</span>        <span class="o">/*</span> <span class="n">first</span> <span class="n">reader</span> <span class="n">synchronizes</span> <span class="k">with</span> <span class="n">writers</span> <span class="n">to</span> <span class="n">acquire</span> <span class="n">the</span> <span class="n">resource</span> <span class="o">*/</span>
<span class="linenos">31</span>        <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="linenos">32</span>    <span class="p">}</span>
<span class="linenos">33</span>    <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">counter_mutex</span><span class="p">);</span>   
<span class="linenos">34</span><span class="p">}</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="n">static</span> <span class="n">inline</span> <span class="n">void</span> <span class="n">rwlock_release_read</span><span class="p">(</span><span class="n">rwlock_t</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="linenos">37</span><span class="p">{</span>
<span class="linenos">38</span>    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">counter_mutex</span><span class="p">);</span>
<span class="linenos">39</span>    <span class="n">l</span><span class="o">-&gt;</span><span class="n">reader_count</span><span class="o">--</span><span class="p">;</span>
<span class="linenos">40</span>    <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">reader_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">41</span>        <span class="o">/*</span> <span class="n">last</span> <span class="n">reader</span> <span class="n">releases</span> <span class="n">the</span> <span class="n">resource</span> <span class="o">*/</span>
<span class="linenos">42</span>        <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="linenos">43</span>    <span class="p">}</span>
<span class="linenos">44</span>    <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">counter_mutex</span><span class="p">);</span>
<span class="linenos">45</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>We could combine the release functions and just have a single <code class="docutils literal notranslate"><span class="pre">rwlock_release()</span></code> function invoked by either reader or writer threads. When a writer releases the lock, the <code class="docutils literal notranslate"><span class="pre">reader_count</span></code> should already be <code class="docutils literal notranslate"><span class="pre">0</span></code>; in that case we skip decrementing <code class="docutils literal notranslate"><span class="pre">reader_count</span></code> and just post to the <code class="docutils literal notranslate"><span class="pre">mutex</span></code>. This is the approach taken by the pthreads library implementation of reader/writer locks (<code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">-k</span> <span class="pre">pthread_rwlock</span></code>).</p>
<p>In this implementation of rwlocks, intensive read activity could starve writer threads. An alternative is to give writers priority: as soon as a writer thread requests access to the shared data, no new reader threads are allowed access until the writer is done using the data. The writer must still wait for existing reader threads to finish and release the data, but writers will not starve. If write activity is intense enough to worry about starving readers, then rwlocks are probably not a good choice anyway.</p>
</section>
<section id="performance-of-rwlocks">
<h2><span class="section-number">37.2. </span>Performance of rwlocks<a class="headerlink" href="#performance-of-rwlocks" title="Permalink to this headline">#</a></h2>
<p>To be added.</p>
</section>
<section id="read-copy-update">
<span id="cont-sync-readmostly-rcu"></span><h2><span class="section-number">37.3. </span>Read-Copy Update<a class="headerlink" href="#read-copy-update" title="Permalink to this headline">#</a></h2>
</section>
</section>


<script type="application/vnd.jupyter.widget-state+json">
{"state": {"1ae543b38769473f8419d57532ca5e25": {"model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "model_name": "OutputModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_651fb80d4b3d4053b71d94918cf67b68", "msg_id": "", "outputs": [{"name": "stdout", "output_type": "stream", "text": "$ [[ -d mydir ]] && rm -rf mydir\r\n$     #\r\n$ "}]}}, "651fb80d4b3d4053b71d94918cf67b68": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": "1px solid black", "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "100%", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": "scroll", "padding": null, "right": null, "top": null, "visibility": null, "width": null}}}, "version_major": 2, "version_minor": 0}
</script>


    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./sync"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="concurrency_bugs.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">36. </span>Common Concurrency Bugs</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="hardware_challenges.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">38. </span>Challenges of Modern Hardware</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By (see contributing chapter book)<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>